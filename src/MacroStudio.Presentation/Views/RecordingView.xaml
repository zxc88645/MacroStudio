<UserControl x:Class="MacroStudio.Presentation.Views.RecordingView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:conv="clr-namespace:MacroStudio.Presentation.Converters"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="320">
    <UserControl.Resources>
        <conv:CommandDisplayConverter x:Key="CommandDisplayConverter" />
        <conv:ResourceFormatConverter x:Key="ResourceFormatConverter" />
        <conv:ArduinoConnectionStateBrushConverter x:Key="ArduinoConnectionStateBrushConverter" />
    </UserControl.Resources>
    <!-- Keep this panel from growing unbounded (it lives in an Auto row in MainWindow). -->
    <Border Style="{DynamicResource CardBorder}" Padding="14" MaxHeight="340">
        <DockPanel LastChildFill="True">
            <DockPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                <StackPanel Orientation="Horizontal">
                    <TextBlock FontWeight="SemiBold" Text="{DynamicResource Ui.Recording.Title}" />
                    <!-- Arduino 連接狀態燈 -->
                    <Ellipse Width="10" Height="10" Margin="8,0,0,0"
                             VerticalAlignment="Center"
                             ToolTip="{Binding Recording.ArduinoConnectionState, StringFormat='Arduino: {0}'}"
                             Fill="{Binding Recording.ArduinoConnectionState, Converter={StaticResource ArduinoConnectionStateBrushConverter}}" />
                </StackPanel>
                <TextBlock DockPanel.Dock="Right"
                           Foreground="{DynamicResource TextMutedBrush}"
                           Text="{Binding Recording.RecordingStatusText}" />
            </DockPanel>

            <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">
                <WrapPanel Margin="0,0,0,8">
                    <Button Content="{DynamicResource Ui.Recording.Start}" Width="72" Margin="0,0,8,8"
                            Style="{DynamicResource PrimaryButton}"
                            Command="{Binding Recording.StartRecordingCommand}" />
                    <Button Content="{Binding Recording.PauseButtonText}" Width="72" Margin="0,0,8,8"
                            Command="{Binding Recording.PauseRecordingCommand}" />
                    <Button Content="{DynamicResource Ui.Recording.Stop}" Width="72" Margin="0,0,8,8"
                            Command="{Binding Recording.StopRecordingCommand}" />
                </WrapPanel>

                <GroupBox Header="{DynamicResource Ui.Recording.Options}" Padding="10" BorderBrush="{DynamicResource BorderBrushSoft}" Foreground="{DynamicResource TextMutedBrush}">
                    <StackPanel>
                        <CheckBox Content="{DynamicResource Ui.Recording.RecordMouseMovements}" IsChecked="{Binding Recording.RecordMouseMovements}" />
                        <CheckBox Content="{DynamicResource Ui.Recording.UseRelativeMouseMove}" IsChecked="{Binding Recording.UseRelativeMouseMove}" />
                        <CheckBox Content="{DynamicResource Ui.Recording.RecordMouseClicks}" IsChecked="{Binding Recording.RecordMouseClicks}" />
                        <CheckBox Content="{DynamicResource Ui.Recording.RecordKeyboardInput}" IsChecked="{Binding Recording.RecordKeyboardInput}" />
                        <CheckBox Content="{DynamicResource Ui.Recording.FilterInjectedSystemEvents}" IsChecked="{Binding Recording.FilterSystemEvents}" />
                    </StackPanel>
                </GroupBox>

                <DockPanel Margin="0,10,0,0">
                    <TextBlock Foreground="{DynamicResource TextMutedBrush}"
                               VerticalAlignment="Center"
                               Text="{Binding Recording.TotalCommands, Converter={StaticResource ResourceFormatConverter}, ConverterParameter=Ui.Recording.RecordedCountFormat}" />
                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                        <Button Content="←"
                                Width="28"
                                Margin="0,0,8,0"
                                ToolTip="{DynamicResource Ui.Recording.InsertIntoEditor}"
                                Command="{Binding Recording.InsertRecordedIntoEditorCommand}" />
                        <Button Content="{DynamicResource Ui.Recording.CopyScript}"
                                Margin="0,0,8,0"
                                ToolTip="{DynamicResource Ui.Recording.CopyScript}"
                                Command="{Binding Recording.CopyCurrentScriptTextCommand}" />
                        <Button Content="{DynamicResource Ui.Recording.SaveAsScript}"
                                Style="{DynamicResource PrimaryButton}"
                                Command="{Binding Recording.SaveAsScriptCommand}" />
                    </StackPanel>
                </DockPanel>
            </StackPanel>

            <ListBox ItemsSource="{Binding Recording.RecordedCommands}"
                     BorderThickness="0"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                     ScrollViewer.CanContentScroll="True"
                     VirtualizingPanel.IsVirtualizing="True"
                     VirtualizingPanel.VirtualizationMode="Recycling">
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <VirtualizingStackPanel />
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding ., Converter={StaticResource CommandDisplayConverter}}"
                                   Foreground="{DynamicResource TextBrush}"
                                   TextWrapping="Wrap"
                                   Margin="0,2"/>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </DockPanel>
    </Border>
</UserControl>

