<Window x:Class="MacroStudio.Presentation.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:MacroStudio.Presentation"
        xmlns:vm="clr-namespace:MacroStudio.Presentation.ViewModels"
        xmlns:views="clr-namespace:MacroStudio.Presentation.Views"
        xmlns:conv="clr-namespace:MacroStudio.Presentation.Converters"
        mc:Ignorable="d"
        Title="Macro Studio" Height="900" Width="1600"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource Bg0}">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="220"/>
        </Grid.RowDefinitions>

        <!-- Top bar -->
        <Border Grid.Row="0" Background="{DynamicResource Bg1}" Padding="14">
            <DockPanel LastChildFill="True">
                <StackPanel Orientation="Horizontal">
                    <TextBlock FontSize="18" FontWeight="SemiBold" Text="Macro Studio" />
                    <TextBlock Margin="10,3,0,0" Foreground="{DynamicResource TextMutedBrush}" Text="Desktop Automation" />
                </StackPanel>
                <Button DockPanel.Dock="Right"
                        Margin="12,0,0,0"
                        Style="{DynamicResource DangerButton}"
                        Visibility="{Binding IsKillSwitchActive, Converter={StaticResource BoolToVisibility}}"
                        Command="{Binding ResetKillSwitchCommand}"
                        Content="Reset Kill Switch" />
                <TextBlock DockPanel.Dock="Right"
                           Foreground="{DynamicResource TextMutedBrush}"
                           VerticalAlignment="Center"
                           Text="{Binding StatusText}" />
            </DockPanel>
        </Border>

        <!-- Main content: scripts + commands + execution controls -->
        <Grid Grid.Row="1" Margin="14">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/>
                <ColumnDefinition Width="12"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="12"/>
                <ColumnDefinition Width="320"/>
            </Grid.ColumnDefinitions>

            <views:ScriptListView Grid.Column="0"/>

            <views:CommandGridView Grid.Column="2"/>

            <!-- Execution controls -->
            <Border Grid.Column="4" Style="{DynamicResource CardBorder}" Padding="14">
                <DockPanel LastChildFill="True">
                    <StackPanel DockPanel.Dock="Top" Orientation="Vertical">
                        <TextBlock FontWeight="SemiBold" Text="Execution" Margin="0,0,0,8"/>

                        <TextBlock Foreground="{DynamicResource TextMutedBrush}" Text="{Binding ExecutionControls.State}" Margin="0,0,0,8"/>

                        <ProgressBar Height="14"
                                     Minimum="0" Maximum="100"
                                     Value="{Binding ExecutionControls.CompletionPercentage}" />
                        <TextBlock Margin="0,6,0,8"
                                   Foreground="{DynamicResource TextMutedBrush}"
                                   Text="{Binding ExecutionControls.CurrentCommandIndex}"/>

                        <WrapPanel Margin="0,6,0,8">
                            <Button Content="Start" Width="72" Margin="0,0,8,8" Style="{DynamicResource PrimaryButton}" Command="{Binding ExecutionControls.StartCommand}"/>
                            <Button Content="Pause" Width="72" Margin="0,0,8,8" Command="{Binding ExecutionControls.PauseCommand}"/>
                            <Button Content="Resume" Width="72" Margin="0,0,8,8" Command="{Binding ExecutionControls.ResumeCommand}"/>
                            <Button Content="Stop" Width="72" Margin="0,0,8,8" Command="{Binding ExecutionControls.StopCommand}"/>
                            <Button Content="Step" Width="72" Margin="0,0,8,8" Command="{Binding ExecutionControls.StepCommand}"/>
                            <Button Content="Terminate" Width="88" Margin="0,0,8,8" Style="{DynamicResource DangerButton}" Command="{Binding ExecutionControls.TerminateCommand}"/>
                        </WrapPanel>

                        <GroupBox Header="Options" Padding="10" BorderBrush="{DynamicResource BorderBrushSoft}" Foreground="{DynamicResource TextMutedBrush}">
                            <StackPanel>
                                <DockPanel Margin="0,0,0,6">
                                    <TextBlock Width="120" Text="Speed" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding ExecutionControls.SpeedMultiplier, UpdateSourceTrigger=PropertyChanged}" />
                                </DockPanel>
                                <CheckBox Content="Show countdown" IsChecked="{Binding ExecutionControls.ShowCountdown}" />
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Width="120" Text="Countdown (s)" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding ExecutionControls.CountdownSeconds, UpdateSourceTrigger=PropertyChanged}" />
                                </DockPanel>
                                <TextBlock Foreground="{DynamicResource DangerBrush}" Margin="0,10,0,0" Text="{Binding ExecutionControls.LastError}" TextWrapping="Wrap"/>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Logging panel -->
        <Border Grid.Row="2" Margin="14" Style="{DynamicResource CardBorder}" Padding="14">
            <DockPanel LastChildFill="True">
                <DockPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                    <TextBlock FontWeight="SemiBold" Text="Logs" />
                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                        <Button Content="Refresh" Margin="0,0,8,0" Command="{Binding Logging.RefreshCommand}" />
                        <Button Content="Clear" Margin="0,0,8,0" Command="{Binding Logging.ClearCommand}" />
                        <Button Content="Copy" Margin="0,0,8,0" Command="{Binding Logging.CopyCommand}" />
                        <Button Content="Export" Style="{DynamicResource PrimaryButton}" Command="{Binding Logging.ExportCommand}" />
                    </StackPanel>
                </DockPanel>

                <DockPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                    <TextBox Width="260" Margin="0,0,8,0"
                             Text="{Binding Logging.SearchText, UpdateSourceTrigger=PropertyChanged}"
                             ToolTip="Search logs"/>
                    <TextBox Width="80" Margin="0,0,8,0"
                             Text="{Binding Logging.MaxResults, UpdateSourceTrigger=PropertyChanged}"
                             ToolTip="Max results"/>
                </DockPanel>

                <ListBox x:Name="LogsListBox" ItemsSource="{Binding Logging.Entries}" BorderThickness="0">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <DockPanel Margin="0,2">
                                <Border Width="10" Height="10" CornerRadius="5"
                                        Margin="0,4,10,0"
                                        Background="{Binding Level, Converter={StaticResource LogLevelBrushConverter}}"/>
                                <TextBlock Text="{Binding ., Converter={StaticResource LogEntryDisplayConverter}}"
                                           Foreground="{DynamicResource TextBrush}"
                                           TextWrapping="Wrap"/>
                            </DockPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>
        </Border>
    </Grid>
</Window>
